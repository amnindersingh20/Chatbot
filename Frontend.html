#!/usr/bin/env python3
"""
Employee ID Filter & Duplicate Finder

Tkinter GUI with two responsive tabs:
 - **Filter**: apply ID-based filtering to CSV/TXT files
 - **Compare**: find duplicates between two ID lists

The interface expands with the window, highlights grouped sections, and uses ttk themes.
"""
import csv
import re
import os
import tkinter as tk
from tkinter import ttk, filedialog, messagebox
from datetime import datetime

# Utility

def timestamp():
    return datetime.now().strftime('%Y%m%d_%H%M%S')

# --- Backend Logic ---
def load_csv_ids(path, delim):
    ids = set()
    with open(path, newline='', encoding='utf-8') as f:
        for row in csv.reader(f, delimiter=delim):
            if row and re.fullmatch(r"\d{8}", row[0].strip()):
                ids.add(row[0].strip())
    return ids

def filter_csv(inp, outp, logp, id_set, delim, ts):
    total=removed=0
    tgt_ids=[]
    with open(inp, newline='', encoding='utf-8') as fin, open(outp,'w',newline='',encoding='utf-8') as fout, open(logp,'w',newline='',encoding='utf-8') as logf:
        rdr=csv.reader(fin,delimiter=delim); wtr=csv.writer(fout,delimiter=delim); logw=csv.writer(logf,delimiter=delim)
        first=next(rdr,None)
        if first:
            total+=1; fid=first[0].strip(); tgt_ids.append(fid)
            if not re.fullmatch(r"\d{8}",fid) or fid not in id_set: wtr.writerow(first)
            else: removed+=1; logw.writerow(first)
        for row in rdr:
            total+=1
            if not row: continue
            fid=row[0].strip(); tgt_ids.append(fid)
            if re.fullmatch(r"\d{8}",fid) and fid in id_set: removed+=1; logw.writerow(row)
            else: wtr.writerow(row)
    tgt_file=os.path.join(os.path.dirname(outp),f"TARGET_IDS_{ts}.txt")
    with open(tgt_file,'w',encoding='utf-8') as tf:
        tf.write(f"# Source: {inp}\n");
        for i in tgt_ids: tf.write(i+"\n")
    return tgt_file,total,removed

def filter_txt(inp, outp, logp, id_set, ts):
    total=removed=0
    tgt_ids=[]
    pat=re.compile(r"^(?P<id>\d{8})")
    with open(inp,'r',encoding='utf-8') as fin, open(outp,'w',encoding='utf-8') as fout, open(logp,'w',encoding='utf-8') as logf:
        for line in fin:
            total+=1; m=pat.match(line)
            if m:
                fid=m.group('id'); tgt_ids.append(fid)
                if fid in id_set: removed+=1; logf.write(line); continue
            fout.write(line)
    tgt_file=os.path.join(os.path.dirname(outp),f"TARGET_IDS_{ts}.txt")
    with open(tgt_file,'w',encoding='utf-8') as tf:
        tf.write(f"# Source: {inp}\n");
        for i in tgt_ids: tf.write(i+"\n")
    return tgt_file,total,removed

def load_ids(path):
    s=set()
    with open(path,'r',encoding='utf-8') as f:
        for l in f:
            v=l.strip();
            if v and not v.startswith('#'): s.add(v)
    return s

def find_duplicates(refp,tgtp,outd):
    ref_ids=load_ids(refp); tgt_ids=load_ids(tgtp)
    dup=sorted(ref_ids & tgt_ids)
    ts=timestamp(); dupf=os.path.join(outd,f"duplicates_{ts}.txt")
    with open(dupf,'w',encoding='utf-8') as f:
        for d in dup: f.write(d+"\n")
    return dupf,len(ref_ids),len(tgt_ids),len(dup)

# --- GUI ---
def build_gui():
    root=tk.Tk(); root.title('Employee ID Toolkit')
    # Responsive
    root.columnconfigure(0,weight=1); root.rowconfigure(0,weight=1)

    style=ttk.Style(root); style.theme_use('clam')

    notebook=ttk.Notebook(root)
    notebook.grid(sticky='nsew')

    # Filter Tab
    frm1=ttk.Frame(notebook); frm1.grid_columnconfigure(1,weight=1)
    notebook.add(frm1,text='Filter')
    add_labeled_entry(frm1,'Reference CSV:',0); ref_e=entry_widgets['e0']
    add_browse(frm1,ref_e,0,'csv')
    add_labeled_entry(frm1,'Target File:',1); tgt_e=entry_widgets['e1']
    add_browse(frm1,tgt_e,1,'both')
    add_labeled_entry(frm1,'Output Folder:',2); out_e=entry_widgets['e2']
    add_browse(frm1,out_e,2,'dir')
    ttk.Label(frm1,text='Type:').grid(row=3,column=0,padx=5,pady=5,sticky='e')
    tv1=tk.StringVar(value='csv')
    ttk.Combobox(frm1,textvariable=tv1,values=['csv','txt'],width=5,state='readonly').grid(row=3,column=1,sticky='w',padx=5,pady=5)
    ttk.Label(frm1,text='Ref Delim:').grid(row=4,column=0,padx=5,pady=5,sticky='e')
    rd=ttk.Entry(frm1,width=5); rd.insert(0,'|'); rd.grid(row=4,column=1,sticky='w',padx=5,pady=5)
    ttk.Label(frm1,text='Tgt Delim:').grid(row=5,column=0,padx=5,pady=5,sticky='e')
    td=ttk.Entry(frm1,width=5); td.insert(0,','); td.grid(row=5,column=1,sticky='w',padx=5,pady=5)
    ttk.Button(frm1,text='Run Filter',command=lambda: run_filter(ref_e.get(),tgt_e.get(),out_e.get(),tv1.get(),rd.get(),td.get())).grid(row=6,column=0,columnspan=3,pady=10)

    # Compare Tab
    frm2=ttk.Frame(notebook); frm2.grid_columnconfigure(1,weight=1)
    notebook.add(frm2,text='Compare')
    add_labeled_entry(frm2,'Ref IDs File:',0); r2_e=entry_widgets['e3']
    add_browse(frm2,r2_e,0,'txt')
    add_labeled_entry(frm2,'Tgt IDs File:',1); t2_e=entry_widgets['e4']
    add_browse(frm2,t2_e,1,'txt')
    add_labeled_entry(frm2,'Output Folder:',2); o2_e=entry_widgets['e5']
    add_browse(frm2,o2_e,2,'dir')
    ttk.Button(frm2,text='Find Duplicates',command=lambda: run_compare(r2_e.get(),t2_e.get(),o2_e.get())).grid(row=3,column=0,columnspan=3,pady=10)

    root.mainloop()

# Helper for entries
entry_widgets={}
def add_labeled_entry(parent,label,row):
    ttk.Label(parent,text=label).grid(row=row,column=0,padx=5,pady=5,sticky='e')
    e=ttk.Entry(parent,width=50)
    e.grid(row=row,column=1,padx=5,pady=5,sticky='ew')
    entry_widgets[f'e{row}']=e

# Browse helper
def add_browse(parent,entry_widget,row,mode):
    def cmd():
        if mode=='csv': path=filedialog.askopenfilename(filetypes=[('CSV','*.csv')])
        elif mode=='txt': path=filedialog.askopenfilename(filetypes=[('TXT','*.txt')])
        elif mode=='both': path=filedialog.askopenfilename(filetypes=[('CSV/TXT','*.csv;*.txt')])
        else: path=filedialog.askdirectory()
        if path: entry_widget.delete(0,tk.END); entry_widget.insert(0,path)
    ttk.Button(parent,text='Browse',command=cmd).grid(row=row,column=2,padx=5,pady=5)

# Action handlers
def run_filter(ref,tgt,outdir,typ,rdel,tdel):
    ts=timestamp(); ids=load_csv_ids(ref,rdel)
    ref_file=os.path.join(outdir,f"REFERENCE_IDS_{ts}.txt");
    with open(ref_file,'w') as rf: rf.write(f"# Source: {ref}\n") or [rf.write(i+"\n") for i in sorted(ids)]
    logf=os.path.join(outdir,f"removed_data_{ts}.txt"); name,_=os.path.splitext(os.path.basename(tgt))
    fout=os.path.join(outdir,f"{name}_{ts}.{ 'txt' if typ=='txt' else 'csv'}")
    if typ=='csv': tgt_file,tot,rem=filter_csv(tgt,fout,logf,ids,tdel,ts)
    else: tgt_file,tot,rem=filter_txt(tgt,fout,logf,ids,ts)
    messagebox.showinfo('Filter Done',f"Filtered:{fout}\nLog:{logf}\nRefIDs:{ref_file}\nTgtIDs:{tgt_file}\nProc:{tot},Rem:{rem}")

def run_compare(rf,tf,outdir):
    dupf,rc,tc,dc=find_duplicates(rf,tf,outdir)
    messagebox.showinfo('Compare Done',f"Ref:{rc}\nTgt:{tc}\nDup:{dc}\nOut:{dupf}")

if __name__=='__main__':
    build_gui()
