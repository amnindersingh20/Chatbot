import os
import json
import re
import logging

import boto3
from botocore.exceptions import ClientError

# Configure logging
logger = logging.getLogger()
logger.setLevel(logging.INFO)

# S3 client
s3 = boto3.client("s3")

# Bucket name (set in Lambda env vars)
BUCKET = os.environ["PDF_BUCKET"]

# Regex to grab the last numeric sequence in a filename
_NUM_RE = re.compile(r"(\d+)(?!.*\d)")

def extract_population_id(key: str) -> str:
    """
    Return the top-level folder name (population ID) for any key:
      populationX/filename.pdf
    """
    return key.split("/", 1)[0]

def extract_nin(filename: str) -> int:
    """
    Return the last numeric sequence in a filename as NIN.
    """
    base = os.path.splitext(filename)[0]
    m = _NUM_RE.search(base)
    if not m:
        raise ValueError(f"No numeric sequence found in '{filename}'")
    return int(m.group(1))

def metadata_key_for(pdf_key: str) -> str:
    """
    Side-car filename: keep the .pdf in the base name, then append .metadata.json
      e.g. populationA/foo.pdf -> populationA/foo.pdf.metadata.json
    """
    return f"{pdf_key}.metadata.json"

def lambda_handler(event, context):
    continuation_token = None
    processed = 0
    skipped   = 0

    while True:
        # List up to 1000 objects at a time
        params = {"Bucket": BUCKET, "MaxKeys": 1000}
        if continuation_token:
            params["ContinuationToken"] = continuation_token

        resp = s3.list_objects_v2(**params)
        for obj in resp.get("Contents", []):
            key = obj["Key"]
            if not key.lower().endswith(".pdf"):
                continue

            meta_key = metadata_key_for(key)

            # Optional: skip existing metadata.json
            try:
                s3.head_object(Bucket=BUCKET, Key=meta_key)
                skipped += 1
                continue
            except ClientError as e:
                if e.response["Error"]["Code"] != "404":
                    logger.error(f"Error checking {meta_key}: {e}")
                    skipped += 1
                    continue
                # 404 means no metadata yet â†’ proceed

            # Derive population_id and nin_priority
            try:
                population_id = extract_population_id(key)
                nin = extract_nin(key.split("/")[-1])
            except ValueError as e:
                logger.warning(f"Skipping {key}: {e}")
                skipped += 1
                continue

            # Build metadata JSON under metadataAttributes
            metadata = {
                "metadataAttributes": {
                    "population_id": population_id,
                    "nin_priority":  nin
                }
            }

            # Write (or overwrite) side-car JSON
            try:
                s3.put_object(
                    Bucket=BUCKET,
                    Key=meta_key,
                    Body=json.dumps(metadata, indent=2).encode("utf-8"),
                    ContentType="application/json"
                )
                logger.info(f"Wrote metadata: {meta_key}")
                processed += 1
            except ClientError as e:
                logger.error(f"Failed to write {meta_key}: {e}")
                skipped += 1

        if not resp.get("IsTruncated"):  
            break
        continuation_token = resp.get("NextContinuationToken")

    logger.info(f"Done. processed={processed}, skipped={skipped}")
    return {
        "statusCode": 200,
        "body": json.dumps({"processed": processed, "skipped": skipped})
    }
