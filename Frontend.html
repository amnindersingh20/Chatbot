#!/usr/bin/env python3
"""
This script compares a pipe-delimited CSV file against a space-delimited TXT file,
but identifies blocks solely by the 8-digit numeric employee ID at the start of each block.
Any TXT block whose header ID matches one in the CSV will be removed and logged.
Blocks are delimited by lines beginning with an 8-digit numeric ID.
Includes summary counts to confirm removals.
"""
import csv
import argparse
import sys
import re


def load_csv_ids(csv_path, delimiter="|"):
    """
    Load the CSV and build a set of 8-digit employee IDs (first CSV field).
    """
    ids = set()
    with open(csv_path, newline='', encoding='utf-8') as f:
        reader = csv.reader(f, delimiter=delimiter)
        for row in reader:
            if not row:
                continue
            emp_id = row[0].strip()
            if re.fullmatch(r"\d{8}", emp_id):
                ids.add(emp_id)
    print(f"Loaded {len(ids)} employee IDs from CSV: {csv_path}")
    return ids


def filter_txt_by_id(txt_in, txt_out, removed_log, id_set):
    """
    Read the TXT, detect blocks by 8-digit ID at line start, and remove matching blocks.
    Writes removed blocks to log and keeps other lines in output.
    """
    in_remove = False
    total_lines = 0
    removed_lines = 0
    blocks_removed = 0

    id_header_re = re.compile(r"^(?P<id>\d{8})")

    with open(txt_in, 'r', encoding='utf-8') as fin, \
         open(txt_out, 'w', encoding='utf-8') as fout, \
         open(removed_log, 'w', encoding='utf-8') as logf:
        for line in fin:
            total_lines += 1
            m = id_header_re.match(line.strip())
            if m:
                current_id = m.group('id')
                # Decide block removal state for this new block
                if current_id in id_set:
                    in_remove = True
                    blocks_removed += 1
                else:
                    in_remove = False

            if in_remove:
                removed_lines += 1
                logf.write(line)
            else:
                fout.write(line)

    print(f"Processed {total_lines} lines from TXT: {txt_in}")
    print(f"Removed {removed_lines} lines across {blocks_removed} blocks (logged to {removed_log})")
    if removed_lines == 0:
        print("Warning: no lines removed. Check that the TXT headers use 8-digit IDs matching the CSV.", file=sys.stderr)


def main():
    parser = argparse.ArgumentParser(
        description="Filter TXT blocks by employee ID (first 8 digits), logging removed blocks."
    )
    parser.add_argument('csv_file', help='Path to the pipe-delimited CSV')
    parser.add_argument('txt_file', help='Path to the space-delimited TXT')
    parser.add_argument('output_txt', help='Path for filtered TXT output')
    parser.add_argument('log_file', help='Path where removed blocks will be logged')
    args = parser.parse_args()

    id_set = load_csv_ids(args.csv_file)
    filter_txt_by_id(args.txt_file, args.output_txt, args.log_file, id_set)

if __name__ == '__main__':
    main()
